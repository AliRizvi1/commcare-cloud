---
- name: Install ecryptfs-utils
  sudo: yes
  apt: name=ecryptfs-utils state=present

- name: Check for already mounted drive
  shell: cat /etc/mtab
  register: mtab_contents
  changed_when: false

- name: Create encrypted drive root directory
  sudo: yes
  file: path="{{ encrypted_root }}" owner=root group=root mode=0755 state=directory

- name: Add encryption password to keyring
  sudo: yes
  shell: 'printf "%s" "{{ ECRYPTFS_PASSWORD }}" | ecryptfs-add-passphrase | grep -o "\[.*\]" | sed "s/\[//g;s/\]//g"'
  register: password_hash
  when: "'{{ encrypted_root }}' not in mtab_contents.stdout"

- name: Mount data drive
  sudo: yes
  shell: "mount -t ecryptfs -o key=passphrase:passphrase_passwd={{ ECRYPTFS_PASSWORD }},user,noauto,ecryptfs_cipher=aes,ecryptfs_key_bytes=32,ecryptfs_unlink_sigs,ecryptfs_enable_filename_crypto=y,ecryptfs_fnek_sig={{ password_hash.stdout }},verbosity=0 {{ encrypted_root }}/ {{ encrypted_root }}/"
  when: "'{{ encrypted_root }}' not in mtab_contents.stdout"

- name: Create /opt/data/blobdb directory for setups that do not use NFS
  sudo: yes
  when: not shared_drive_enabled
  file: path=/opt/data/blobdb owner=nobody group={{ shared_dir_gid }} mode=0775 state=directory
  tags:
    - ecryptfs-blobdb

- name: Create blob DB symlink (cchq looks for it in the shared drive)
  sudo: yes
  when: not shared_drive_enabled
  file: src=/opt/data/blobdb dest={{ shared_data_dir }}/blobdb state=link
  tags:
    - ecryptfs-blobdb

- name: Drop unencrypted readme in directory
  sudo: yes
  lineinfile:
    dest: '{{ encrypted_root }}/README'
    line: 'If you can read this file the directory is unencrypted'
    create: yes
    owner: root
    group: root
    mode: 0770

- name: Register mount configuration
  sudo: yes
  shell: "cat /etc/mtab | grep '{{ encrypted_root }}'"
  register: mount_conf
  changed_when: false

- name: add user, noauto to mount conf
  shell: "echo {{ mount_conf.stdout }} | sed -e 's/rw/user,noauto,rw/'"
  when: "'noauto' not in mount_conf.stdout"
  register: updated_mount_conf

- name: Create entry in fstab
  sudo: yes
  lineinfile:
    dest: "/etc/fstab"
    regexp: "^{{ encrypted_root }}"
    backup: yes
    line: "{{ updated_mount_conf.stdout if not 'skipped' in updated_mount_conf else mount_conf.stdout }}"
  when: "'{{ encrypted_root }}' not in mtab_contents.stdout"
