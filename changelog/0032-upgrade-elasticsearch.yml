---
title: ES upgrade from 1.7.6 to 2.4.6
key: upgrade-elasticsearch
date: 2020-02-05
optional_per_env: no
min_commcare_version: 064bb6dfc2b333cc8e6e3955b0c5d30513c5f4be
context: |
  This change upgrade Elasticsearch from 1.7.6 to 2.4.6 version.

details: |
  As part of our ongoing effort to keep CommCare HQ up to date with the latest tools and
  libraries we have updated Elasticsearch from 1.7.6 to 2.4.6 version.

update_steps: |

  1. Stop the site
  ```bash
  commcare-cloud <env> downtime start
  ```
    
  2. Add the following parameters to your environment's `public.yml`:
  ```
  elasticsearch_version: 2.4.6
  elasticsearch_download_sha256: 5f7e4bb792917bb7ffc2a5f612dfec87416d54563f795d6a70637befef4cfc6f.
  ELASTICSEARCH_MAJOR_VERSION: 2
  ```
    
  3. Update the local settings
  ```bash
  commcare-cloud <env> update-config
  ```
  
  4. Disable the cluster routing
  ```bash
  curl -X PUT "<ES-IP>:9200/_cluster/settings?pretty" -H 'Content-Type: application/json' -d'
  {
    "persistent": {
       "cluster.routing.allocation.enable": "none"
    }
  }
  '
  ```

  5. Perform a synced flush
  ```bash
  curl -X POST ""<ES-IP>:9200/_flush/synced?pretty"
  ```
    
  6. Stop the Monit and Elasticsearch services
  ```bash
  commcare-cloud <env> run-shell-command all "service monit stop" -b --limit=elasticsearch
  commcare-cloud <env> run-shell-command all "service elasticsearch stop" -b --limit=elasticsearch
  ```
    
  7. Install and run the new version of Elasticsearch
  ```bash
  commcare-cloud <env> ansible-playbook deploy_stack.yml --limit=elasticsearch --tags=elasticsearch
  ```
    
  8. Stop the Monit and Elasticsearch services
  ```bash
  commcare-cloud <env> run-shell-command all "service monit stop" -b --limit=elasticsearch
  commcare-cloud <env> run-shell-command all "service elasticsearch stop" -b --limit=elasticsearch
  ```
    
  9. Rename the newly created 2.4.6 data directory with diffrent name and then rename the 1.7.6 data folder with new version 2.4.6
  ```bash
  commcare-cloud <env> run-shell-command all "mv /opt/data/elasticsearch-2.4.6 /opt/data/elasticsearch-2.4.6-new-installation" -b --limit=elasticsearch
  commcare-cloud <env> run-shell-command all "mv /opt/data/elasticsearch-1.7.6 /opt/data/elasticsearch-2.4.6" -b --limit=elasticsearch
  ```
    
  10. Verify the permissions of data folder and new data direcory size
  ```bash
  commcare-cloud <env> run-shell-command all "du -ch /opt/data/elasticsearch-2.4.6" -b --limit=elasticsearch
  ```
    
  11. Start the Monit and Elasticsearch services
  ```bash
  commcare-cloud <env> run-shell-command all "service monit start" -b --limit=elasticsearch
  commcare-cloud <env> run-shell-command all "service elasticsearch start" -b --limit=elasticsearch
  ```
    
  12. Verify that the cluster status is yellow
  ```bash
  curl -XGET <ES-IP>:9200/_cluster/health?pretty
  ```
    
  12. Enable the cluster routing
  ```bash
  curl -X PUT "<ES-IP>:9200/_cluster/settings?pretty" -H 'Content-Type: application/json' -d'
  {
    "persistent": {
       "cluster.routing.allocation.enable": "all"
    }
  }
  '
  ```
    
  14. Start the site
  ```bash
  commcare-cloud <env> downtime end
  ```
