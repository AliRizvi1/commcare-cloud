_completion_props() {
    if [[ -z "${COMPLETION_PROPS}" ]]
    then
        COMPLETION_PROPS="$(manage-commcare-cloud get environments commands ANSIBLE_DIR)"
    fi
    echo "$COMPLETION_PROPS"
}


_commcare_cloud()
{
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"
    opts="--help --version"

    export COMPLETION_PROPS="$(_completion_props)"
    COMMCARE_CLOUD_ENVS=$(echo "${COMPLETION_PROPS}" | head -n1)
    COMMCARE_CLOUD_CMDS=$(echo "${COMPLETION_PROPS}" | head -n2 | tail -n1)
    FILE_EXCHANGE_DIR=$(echo "${COMPLETION_PROPS}" | head -n3 | tail -n1)

    # only include .yml files that don't contain a space
    files=$(echo $(ls ${FILE_EXCHANGE_DIR} | grep -v ' ' | grep '.*.yml$'))

    case $COMP_CWORD in
    1)
        if [[ ${cur} == -* ]] ; then
            COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
        else
            COMPREPLY=( $(compgen -W "${COMMCARE_CLOUD_ENVS}" -- ${cur}) )
        fi
        ;;
    2)
        if [[ ${cur} == * ]] ; then
            COMPREPLY=( $(compgen -W "${COMMCARE_CLOUD_CMDS}" -- ${cur}) )
        fi
        ;;
    3)
        COMPREPLY=( $(compgen -W "${files}" -- ${cur}) )
        ;;
    esac
}
complete -F _commcare_cloud commcare-cloud
complete -F _commcare_cloud cchq
