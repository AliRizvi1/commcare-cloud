terraform {
  backend "s3" {
    bucket  = {{ state_bucket|tojson }}
    key     = "state/{{ environment }}.tfstate"
    region  = {{ state_bucket_region|tojson }}
    encrypt = true
  }
}

provider "aws" {
  region  = {{ region|tojson }}
}

module "commcarehq" {
  source = "../modules/commcarehq"
  region = {{ region|tojson }}
  environment = {{ environment|tojson }}
  company = "dimagi"
  azs = {{ azs|tojson }}
  vpc_begin_range = "10.200"
  dns_domain = ""
  # Set the DNS Domain name to be used (should match the name for the Zone ID)
  dns_zone_id = ""
  # Select the correct DNS Zone ID from Route 53
  internal_ssl_cert_arn = ""
  # This will be used to reference SSL Certificate in AWS Certificate Manager
  external_routes = [
  {%- for external_route in external_routes %}
    {
      cidr_block = {{ external_route.cidr_block|tojson }}
      gateway_id = {{ external_route.gateway_id|tojson }}
    },
  {%- endfor %}
  ]

  servers = [
  {%- for server in servers %}
    {
      server_name = {{ server.server_name|tojson }}
      server_instance_type = {{ server.server_instance_type|tojson }}
      network_tier = {{ server.network_tier|tojson }}
      az = {{ server.az|tojson }}
      volume_size = {{ server.volume_size|tojson }}
    },
  {%- endfor %}
  ]

  proxy_servers = [
  {%- for server in proxy_servers %}
    {
      server_name = {{ server.server_name|tojson }}
      server_instance_type = {{ server.server_instance_type|tojson }}
      network_tier = {{ server.network_tier|tojson }}
      az = {{ server.az|tojson }}
      volume_size = {{ server.volume_size|tojson }}
    },
  {%- endfor %}
  ]

  rds_instances = [
  {%- for rds_instance in rds_instances %}
    {
      password = "${var.rds_password}"
      identifier = {{ rds_instance.identifier|tojson }}
      instance_type = {{ rds_instance.instance_type|tojson }}
      storage = {{ rds_instance.storage|tojson }}
    },
  {%- endfor %}
  ]
}
