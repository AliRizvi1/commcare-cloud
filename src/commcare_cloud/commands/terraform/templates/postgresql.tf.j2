{% with count = 5 -%}
locals {
  rds_instances = [
    {%- for i in range(count) %}
    "${merge(local.default_rds, var.rds_instances[{{ i }} < length(var.rds_instances) ? {{ i }} : 0])}",
    {%- endfor %}
  ]
}

{% for i in range(count) %}
module "postgresql-{{ i }}" {
  source = "./modules/postgresql"
  rds_instance = "${local.rds_instances[{{ i }}]}"
  subnet_ids = "${local.rds_subnet_ids}"
  vpc_security_group_ids = "${local.rds_vpc_security_group_ids}"
  create = "${ {{ i }} < length(var.rds_instances) ? 1 : 0 }"
}
{%- endfor %}
{%- endwith %}
